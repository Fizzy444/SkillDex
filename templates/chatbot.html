<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resume Assistant</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .chat-container {
        background: white;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    .chat-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 20px 30px;
        text-align: center;
        position: relative;
        flex-shrink: 0;
        z-index: 2;
    }
    
    .chat-header h2 { font-size: 28px; font-weight: 600; margin-bottom: 5px; }
    .chat-header p { font-size: 16px; opacity: 0.9; }

    .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #4ade80;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .messages-container {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        background: #f8fafc;
        min-height: 0;
        scroll-behavior: smooth;
    }

    .message {
        margin-bottom: 25px;
        display: flex;
        animation: fadeInUp 0.5s ease;
    }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .bot-message { justify-content: flex-start; }
    .user-message { justify-content: flex-end; }

    .message-content { max-width: 70%; padding: 18px 24px; border-radius: 20px; position: relative; }
    .bot-message .message-content { background: white; color: #374151; border-bottom-left-radius: 5px; box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1); }
    .user-message .message-content { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-bottom-right-radius: 5px; }
    .message-time { font-size: 12px; opacity: 0.7; margin-top: 8px; text-align: right; }
    .bot-message .message-time { text-align: left; }

    .typing-indicator { 
        display: none; 
        padding: 15px 20px; 
        margin: 10px 30px; 
        background: white; 
        border-radius: 20px;
        width: fit-content;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
    }
    .typing-indicator.active { display: flex; align-items: center; }
    .typing-dots { display: flex; gap: 4px; }
    .typing-dots span { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; animation: typing 1.4s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }

    .input-area {
        padding: 20px 30px 30px 30px;
        background: white;
        border-top: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column; 
        gap: 15px;
        flex-shrink: 0;
    }

    .input-row {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        width: 100%;
    }

    .textarea-container { flex: 1; position: relative; }
    .input-area textarea {
        width: 100%;
        min-height: 52px;
        max-height: 200px;
        padding: 16px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 25px;
        font-size: 16px;
        font-family: inherit;
        outline: none;
        resize: none;
        transition: all 0.3s ease;
        line-height: 1.4;
        overflow-y: auto;
    }
    .input-area textarea:focus { border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
    .input-area textarea::placeholder { color: #9ca3af; }

    .send-button, .image-upload-btn {
        border-radius: 50%;
        width: 52px;
        height: 52px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .send-button {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white; border: none; font-size: 20px;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }
    .send-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4); }
    .send-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3); }

    .image-upload-btn { background: #f8fafc; border: 2px solid #e2e8f0; color: #64748b; }
    .image-upload-btn:hover { background: #e0e0e0; border-color: #c0c0c0; }

    #imagePreviewContainer {
        display: flex; 
        align-items: center; 
        gap: 10px; 
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 15px; 
        width: fit-content;
    }
    #imagePreviewImg { 
        width: 80px; 
        height: 80px; 
        object-fit: cover; 
        border-radius: 8px; 
    }
    #removeImageBtn {
        background: #ef4444;
        color: white; 
        border: none; 
        border-radius: 50%;
        width: 28px;
        height: 28px; 
        cursor: pointer; 
        font-size: 18px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        transition: background 0.2s ease;
    }
    #removeImageBtn:hover {
        background: #dc2626;
    }

    .uploaded-image { display: flex; flex-direction: column; align-items: flex-end; }
    .image-preview { max-width: 200px; max-height: 200px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
    .uploaded-image p { 
        margin-top: 0; 
        padding-top: 10px; 
        border-top: 1px solid rgba(255,255,255,0.2);
        font-size: 0.9em; 
        opacity: 0.8;
    }

    .message-content h1, .message-content h2, .message-content h3 { margin: 15px 0 10px 0; font-weight: 600; }
    .message-content ul, .message-content ol { margin: 10px 0; padding-left: 20px; }
    .message-content code { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; }
    .message-content pre { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; overflow-x: auto; margin: 15px 0; }
    .message-content pre code { background: none; padding: 0; }
    .streaming-cursor { display: inline-block; width: 2px; height: 1em; background: #4facfe; animation: blink 1s infinite; margin-left: 2px; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    
    .messages-container::-webkit-scrollbar {
        width: 8px;
    }
    .messages-container::-webkit-scrollbar-track {
        background: transparent;
    }
    .messages-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e1; 
        border-radius: 4px; 
        border: none;
        transition: background-color .2s ease;
    }
    .messages-container::-webkit-scrollbar-thumb:hover {
        background-color: #a8b6c8;
    }

    @media (max-width: 768px) {
        .chat-header { padding: 15px 20px; }
        .chat-header h2 { font-size: 24px; }
        .messages-container { padding: 15px; } 
        .input-area { padding: 10px 15px 15px 15px; }
        .message-content { max-width: 90%; padding: 12px 18px; font-size: 15px; }
        .send-button, .image-upload-btn { width: 48px; height: 48px; }
        .input-area textarea { padding: 12px 18px; min-height: 48px; font-size: 15px; } 
        .typing-indicator { margin: 10px 15px; }
        
        #imagePreviewContainer { margin-bottom: 10px; } 
        #imagePreviewImg { width: 60px; height: 60px; }
        #removeImageBtn { width: 22px; height: 22px; font-size: 14px; }
    }

    @media (max-width: 480px) {
        .chat-header h2 { font-size: 22px; }
        .chat-header p { font-size: 14px; }
        .message-content { max-width: 95%; padding: 10px 15px; font-size: 14px; }
        .input-row { gap: 10px; }
        .send-button, .image-upload-btn { width: 44px; height: 44px; font-size: 18px; }
        .input-area textarea { min-height: 44px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="chat-header-info">
        <h2>Resume Assistant</h2>
        <p><span class="status-dot"></span>Online • Ready to help</p>
      </div>
    </div>

    <div class="messages-container" id="messages">
      <div class="message bot-message">
        <div class="message-content">
          <p>Hello! I'm your resume assistant. I can help you with information about skills, experience, education, projects, and career goals. What would you like to know?</p>
          <div class="message-time">Just now</div>
        </div>
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>

    <div class="input-area">
      <!-- Image Preview Section -->
      <div id="imagePreviewContainer" style="display:none;">
        <img id="imagePreviewImg" src="" alt="Image Preview"/>
        <button id="removeImageBtn">&times;</button>
      </div>
      
      <div class="input-row">
        <label for="imageInput" class="image-upload-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>
        </label>
        <input type="file" id="imageInput" accept="image/*" style="display:none"/>
        <div class="textarea-container">
          <textarea id="userInput" placeholder="Ask a question or upload an image..." rows="1"></textarea>
        </div>
        <button class="send-button" id="sendButton" disabled>➤</button>
      </div>
    </div>
  </div>

  <script>
    const messagesContainer = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreviewImg = document.getElementById('imagePreviewImg');
    const removeImageBtn = document.getElementById('removeImageBtn');

    let sessionId = 'session_' + Date.now();

    function getCurrentMode() {
        const urlParams = new URLSearchParams(window.location.search);
        const modeFromURL = urlParams.get('mode');
        if (modeFromURL) {
            sessionStorage.setItem("chatMode", modeFromURL);
            console.log("DEBUG: Mode set from URL:", modeFromURL);
            return modeFromURL;
        }
        const modeFromStorage = sessionStorage.getItem("chatMode");
        if (modeFromStorage) {
            console.log("DEBUG: Mode from storage:", modeFromStorage);
            return modeFromStorage;
        }
        console.log("DEBUG: No mode found, defaulting to 'resume'.");
        return 'resume'; 
    }

    function updateHeaderForMode(mode) {
        const headerTitle = document.querySelector('.chat-header h2');
        const headerSubtitle = document.querySelector('.chat-header p');
        
        switch(mode) {
            case 'urgent':
                headerTitle.textContent = 'Urgent Task Assistant';
                headerSubtitle.innerHTML = '<span class="status-dot"></span>Online • Ready for urgent tasks';
                break;
            case 'resume':
                headerTitle.textContent = 'Resume Assistant';
                headerSubtitle.innerHTML = '<span class="status-dot"></span>Online • Ready to analyze resumes';
                break;
            case 'interview':
                headerTitle.textContent = 'Interview Coach';
                headerSubtitle.innerHTML = '<span class="status-dot"></span>Online • Ready for interview practice';
                break;
            default:
                headerTitle.textContent = 'General Assistant';
                headerSubtitle.innerHTML = '<span class="status-dot"></span>Online • How can I help?';
        }
    }

    function updateInitialMessage(mode) {
        const initialMessage = document.querySelector('.bot-message .message-content p');
        
        switch(mode) {
            case 'urgent':
                initialMessage.textContent = 'Hello! I\'m your urgent task assistant. I can help you prioritize and tackle your most pressing tasks. What urgent matter can I help you with?';
                break;
            case 'resume':
                initialMessage.textContent = 'Hello! I\'m your resume assistant. I can help you with information about skills, experience, education, projects, and career goals. Upload your resume or ask me anything!';
                break;
            case 'interview':
                initialMessage.textContent = 'Hello! I\'m your interview coach. I can help you practice common interview questions, improve your answers, and boost your confidence. Ready to practice?';
                break;
            default: 
                initialMessage.textContent = 'Hello! I\'m a general assistant. How can I help you today?';
        }
    }

    const initialMode = getCurrentMode(); 
    updateHeaderForMode(initialMode);
    updateInitialMessage(initialMode);


    // Auto-resize textarea
    function autoResizeTextarea() {
      userInput.style.height = 'auto'; 
      userInput.style.height = userInput.scrollHeight + 'px';
      
      const maxHeight = 200;
      if (userInput.scrollHeight > maxHeight) {
        userInput.style.height = maxHeight + 'px';
        userInput.style.overflowY = 'auto';
      } else {
        userInput.style.overflowY = 'hidden'; 
      }
      
      const hasText = userInput.value.trim().length > 0;
      sendButton.disabled = !hasText && !imageInput.files[0];
    }

    userInput.addEventListener('input', autoResizeTextarea);
    userInput.addEventListener('paste', () => {
      setTimeout(autoResizeTextarea, 10);
    });

    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          return;
        } else {
          e.preventDefault();
          sendMessage();
        }
      }
    });

    function addMessage(content, isUser = false, imageData = null, isStreaming = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

      let messageContentHTML = '';
      if (imageData && isUser) {
        messageContentHTML = `
          <div class="uploaded-image">
            <img src="${imageData}" alt="Uploaded image" class="image-preview">
            ${content ? `<p>${content}</p>` : ''} <!-- Display user text if available -->
          </div>
        `;
      } else {
        const parsedContent = isUser ? content : marked.parse(content);
        messageContentHTML = `<div class="message-text">${parsedContent}${isStreaming ? '<span class="streaming-cursor"></span>' : ''}</div>`;
      }

      messageDiv.innerHTML = `
        <div class="message-content">
          ${messageContentHTML}
          <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
        </div>
      `;
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      if (!isUser && !isStreaming) {
        messageDiv.querySelectorAll('pre code').forEach(block => {
          hljs.highlightElement(block);
        });
      }
      return messageDiv;
    }

    function updateStreamingMessage(messageElement, content, isComplete = false) {
      const messageTextDiv = messageElement.querySelector('.message-text');
      if (messageTextDiv) { 
        const parsedContent = marked.parse(content);
        messageTextDiv.innerHTML = `${parsedContent}${isComplete ? '' : '<span class="streaming-cursor"></span>'}`;

        if (isComplete) {
          messageElement.querySelectorAll('pre code').forEach(block => {
            hljs.highlightElement(block);
          });
        }
      }
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showTyping(){ typingIndicator.classList.add('active'); messagesContainer.scrollTop = messagesContainer.scrollHeight; }
    function hideTyping(){ typingIndicator.classList.remove('active'); }

    async function sendToAPI(message, imageFile = null) {
      try {
        const formData = new FormData();
        formData.append('message', message);
        formData.append('session_id', sessionId);
        formData.append('stream', 'true');
        
        const mode = getCurrentMode(); 
        formData.append('mode', mode); 
        console.log("DEBUG: Sending mode to API:", mode);

        if (imageFile) {
          formData.append('image', imageFile);
          const allowedTypes = ['image/jpeg','image/jpg','image/png','image/gif','image/bmp','image/webp'];
          if (!allowedTypes.includes(imageFile.type.toLowerCase())) {
            throw new Error(`Unsupported file type: ${imageFile.type}.`);
          }
          if (imageFile.size > 16 * 1024 * 1024) {
            throw new Error('File too large. Max 16MB.');
          }
        }

        const response = await fetch('/chat_api', { method: 'POST', body: formData });
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let botMessageElement = null, finalResponse = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n');
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const jsonData = line.slice(6).trim();
              if (jsonData === '[DONE]') {
                if (botMessageElement) updateStreamingMessage(botMessageElement, finalResponse, true);
                return finalResponse;
              }
              try {
                const data = JSON.parse(jsonData);
                if (data.accumulated) {
                  finalResponse = data.accumulated;
                  if (!botMessageElement) {
                    botMessageElement = addMessage(finalResponse, false, null, true);
                  } else {
                    updateStreamingMessage(botMessageElement, finalResponse, false);
                  }
                }
              } catch(e){ console.warn('Invalid JSON in stream:', jsonData); }
            }
          }
        }
        return finalResponse || "No complete response received.";
      } catch (error) {
        console.error('API Error:', error);
        addMessage(error.message || "Error processing request.", false);
        return "";
      } finally {
        hideTyping();
      }
    }

    // Send message
    async function sendMessage() {
      const message = userInput.value.trim();
      const imageFile = imageInput.files[0];
      if (!message && !imageFile) return;

      if (imageFile) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          addMessage(message || "Image uploaded for analysis", true, e.target.result); 
          userInput.value = ''; 
          hideImagePreview();
          autoResizeTextarea();
          showTyping();
          await sendToAPI(message || "Please analyze this image", imageFile);
        };
        reader.readAsDataURL(imageFile);
      } else if (message) { 
        addMessage(message, true);
        userInput.value = '';
        autoResizeTextarea();
        showTyping();
        await sendToAPI(message);
      }
      sendButton.disabled = true;
    }

    imageInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreviewImg.src = e.target.result;
          imagePreviewContainer.style.display = 'flex';
          autoResizeTextarea();
        };
        reader.readAsDataURL(file);
      } else {
        hideImagePreview();
        autoResizeTextarea(); 
      }
    });

    removeImageBtn.addEventListener('click', hideImagePreview);

    function hideImagePreview() {
      imageInput.value = ''; 
      imagePreviewImg.src = '';
      imagePreviewContainer.style.display = 'none';
      autoResizeTextarea(); 
    }

    sendButton.addEventListener('click', sendMessage);

    userInput.focus();
    autoResizeTextarea();

    window.getCurrentMode = getCurrentMode;

    function extractTodoItems(text) {
      console.log('=== CHECKING FOR TODO ITEMS ===');
      console.log('Full text:', text);
      
      const regex = /\[ADD_TO_TODO\]([\s\S]*?)\[\/ADD_TO_TODO\]/g;
      const matches = [];
      let match;
      
      while ((match = regex.exec(text)) !== null) {
        console.log('Found match:', match[0]);
        console.log('JSON part:', match[1]);
        try {
          const jsonStr = match[1].trim();
          const data = JSON.parse(jsonStr);
          if (data.skill) {
            console.log('Parsed successfully:', data);
            matches.push(data);
          }
        } catch (e) {
          console.error('Failed to parse TODO JSON:', match[1], e);
        }
      }
      
      console.log('Total matches found:', matches.length);
      return matches;
    }

    function cleanResponseText(text) {
      return text.replace(/\[ADD_TO_TODO\][\s\S]*?\[\/ADD_TO_TODO\]/g, '').trim();
    }

    async function addToTodoList(skill, reason, priority) {
      try {
        console.log('Adding to todo:', {skill, reason, priority});
        const response = await fetch('/api/tasks/from-chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: skill,
            reason: reason,
            priority: priority || 'high'
          })
        });

        const result = await response.json();
        console.log('API response:', result);
        
        if (result.success) {
          showNotification(`✓ Added "${skill}" to your to-do list!`, 'success');
          return true;
        } else {
          showNotification('Failed: ' + (result.error || 'Unknown error'), 'error');
          return false;
        }
      } catch (error) {
        console.error('Error adding to todo:', error);
        showNotification('Network error', 'error');
        return false;
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 350px;
        font-size: 14px;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    if (!document.getElementById('notificationStyles')) {
      const style = document.createElement('style');
      style.id = 'notificationStyles';
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(400px); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(400px); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }

    const originalUpdateStreamingMessage = updateStreamingMessage;
    updateStreamingMessage = function(messageElement, content, isComplete = false) {
      const cleanedContent = cleanResponseText(content);
      originalUpdateStreamingMessage(messageElement, cleanedContent, isComplete);
      
      if (isComplete) {
        console.log('Stream complete, checking for todos...');
        const todoItems = extractTodoItems(content);
        if (todoItems.length > 0) {
          console.log('Processing', todoItems.length, 'todo items');
          todoItems.forEach((item, index) => {
            setTimeout(() => {
              addToTodoList(item.skill, item.reason, item.priority);
            }, 500 * (index + 1));
          });
        } else {
          console.log('No TODO items found in response');
        }
      }
    };

    console.log('TODO integration script loaded');
  </script>
</body>
</html>

